<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºè®°ç¬”è®°APP - TraeNote</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #F8F9FA;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #4299E1;
            margin-bottom: 10px;
        }
        
        .nav {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .nav-btn {
            padding: 8px 16px;
            border: 1px solid #4299E1;
            background: white;
            color: #4299E1;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .nav-btn:hover, .nav-btn.active {
            background: #4299E1;
            color: white;
        }
        
        .page {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .page.active {
            display: block;
        }
        
        .upload-area {
            border: 2px dashed #4299E1;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .upload-area:hover {
            background: #EBF8FF;
            border-color: #3182CE;
        }
        
        .upload-area.dragover {
            background: #EBF8FF;
            border-color: #3182CE;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            margin: 5px;
        }
        
        .btn-primary {
            background: #4299E1;
            color: white;
        }
        
        .btn-primary:hover {
            background: #3182CE;
        }
        
        .btn-secondary {
            background: white;
            color: #4299E1;
            border: 1px solid #4299E1;
        }
        
        .btn-secondary:hover {
            background: #4299E1;
            color: white;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .video-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .video-card {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            background: white;
        }
        
        .video-card h3 {
            margin-bottom: 10px;
            color: #4299E1;
        }
        
        .video-card .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            margin: 5px 0;
        }
        
        .status.pending { background: #fef3c7; color: #92400e; }
        .status.processing { background: #dbeafe; color: #1e40af; }
        .status.completed { background: #d1fae5; color: #065f46; }
        .status.failed { background: #fee2e2; color: #991b1b; }
        
        .notebook-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .notebook-card {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .notebook-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .storage-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            text-align: center;
        }
        
        .stat-card h3 {
            color: #4299E1;
            margin-bottom: 10px;
        }
        
        .stat-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: #4299E1;
            transition: width 0.3s ease;
        }
        
        .editor-container {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            background: white;
        }
        
        .editor-toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #fee2e2;
            color: #991b1b;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            border: 1px solid #fca5a5;
        }
        
        .success {
            background: #d1fae5;
            color: #065f46;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            border: 1px solid #6ee7b7;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ æ™ºè®°ç¬”è®°APP</h1>
            <p>AIé©±åŠ¨çš„è§†é¢‘ç¬”è®°ä¸æ™ºèƒ½å­˜å‚¨ç®¡ç†</p>
            <div class="nav">
                <button class="nav-btn active" onclick="showPage('upload')">ğŸ“¤ ä¸Šä¼ è§†é¢‘</button>
                <button class="nav-btn" onclick="showPage('videos')">ğŸ¬ æˆ‘çš„è§†é¢‘</button>
                <button class="nav-btn" onclick="showPage('notebooks')">ğŸ“š ç¬”è®°æœ¬</button>
                <button class="nav-btn" onclick="showPage('editor')">âœï¸ ç¬”è®°ç¼–è¾‘</button>
                <button class="nav-btn" onclick="showPage('storage')">ğŸ’¾ å­˜å‚¨ç®¡ç†</button>
            </div>
        </div>
        
        <!-- ä¸Šä¼ é¡µé¢ -->
        <div id="upload" class="page active">
            <h2>ä¸Šä¼ è§†é¢‘</h2>
            <div class="upload-area" id="uploadArea">
                <div>ğŸ“¹</div>
                <h3>æ‹–æ‹½è§†é¢‘æ–‡ä»¶åˆ°æ­¤å¤„</h3>
                <p>æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                <input type="file" id="fileInput" accept="video/*" class="hidden">
            </div>
            
            <div class="form-group">
                <label>æˆ–è¾“å…¥è§†é¢‘URLï¼š</label>
                <input type="url" id="videoUrl" placeholder="https://example.com/video.mp4">
            </div>
            
            <div class="form-group">
                <label>é€‰æ‹©ç¬”è®°æœ¬ï¼š</label>
                <select id="uploadNotebook">
                    <option value="">åˆ›å»ºæ–°ç¬”è®°æœ¬</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>æ–°ç¬”è®°æœ¬åç§°ï¼š</label>
                <input type="text" id="newNotebookName" placeholder="è¾“å…¥æ–°ç¬”è®°æœ¬åç§°">
            </div>
            
            <button class="btn btn-primary" onclick="uploadVideo()">å¼€å§‹ä¸Šä¼ </button>
            <button class="btn btn-secondary" onclick="processVideoUrl()">å¤„ç†URL</button>
            
            <div id="uploadStatus"></div>
        </div>
        
        <!-- è§†é¢‘åˆ—è¡¨é¡µé¢ -->
        <div id="videos" class="page">
            <h2>æˆ‘çš„è§†é¢‘</h2>
            <div id="videoList" class="video-list"></div>
        </div>
        
        <!-- ç¬”è®°æœ¬é¡µé¢ -->
        <div id="notebooks" class="page">
            <h2>ç¬”è®°æœ¬ç®¡ç†</h2>
            <button class="btn btn-primary" onclick="createNotebook()">æ–°å»ºç¬”è®°æœ¬</button>
            <div id="notebookList" class="notebook-list"></div>
        </div>
        
        <!-- ç¼–è¾‘å™¨é¡µé¢ -->
        <div id="editor" class="page">
            <h2>ç¬”è®°ç¼–è¾‘</h2>
            <div class="editor-container">
                <div class="form-group">
                    <label>é€‰æ‹©è§†é¢‘ï¼š</label>
                    <select id="editorVideoSelect">
                        <option value="">é€‰æ‹©è¦ç¼–è¾‘çš„è§†é¢‘</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>ç¬”è®°æ ‡é¢˜ï¼š</label>
                    <input type="text" id="noteTitle" placeholder="è¾“å…¥ç¬”è®°æ ‡é¢˜">
                </div>
                
                <div class="form-group">
                    <label>AIç”Ÿæˆçš„æ‘˜è¦ï¼š</label>
                    <textarea id="aiSummary" readonly placeholder="AIæ‘˜è¦å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ"></textarea>
                </div>
                
                <div class="form-group">
                    <label>ç¬”è®°å†…å®¹ï¼š</label>
                    <textarea id="noteContent" placeholder="åœ¨è¿™é‡Œç¼–è¾‘ä½ çš„ç¬”è®°..."></textarea>
                </div>
                
                <div class="editor-toolbar">
                    <button class="btn btn-primary" onclick="saveNote()">ä¿å­˜ç¬”è®°</button>
                    <button class="btn btn-secondary" onclick="generateAISummary()">é‡æ–°ç”Ÿæˆæ‘˜è¦</button>
                    <button class="btn btn-secondary" onclick="exportNote()">å¯¼å‡ºç¬”è®°</button>
                </div>
                
                <div id="editorStatus"></div>
            </div>
        </div>
        
        <!-- å­˜å‚¨ç®¡ç†é¡µé¢ -->
        <div id="storage" class="page">
            <h2>å­˜å‚¨ç®¡ç†</h2>
            <div class="storage-stats">
                <div class="stat-card">
                    <h3>æ€»å­˜å‚¨</h3>
                    <div class="value" id="totalStorage">0 MB</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="storageProgress"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <h3>è§†é¢‘æ•°é‡</h3>
                    <div class="value" id="videoCount">0</div>
                </div>
                <div class="stat-card">
                    <h3>ç¬”è®°æ•°é‡</h3>
                    <div class="value" id="noteCount">0</div>
                </div>
                <div class="stat-card">
                    <h3>ç¬”è®°æœ¬æ•°é‡</h3>
                    <div class="value" id="notebookCount">0</div>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <h3>å­˜å‚¨ç­–ç•¥</h3>
                <p>å½“å‰ä½¿ç”¨æœ¬åœ°å­˜å‚¨ç­–ç•¥ï¼Œæ•°æ®ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ä¸­ã€‚</p>
                <button class="btn btn-secondary" onclick="exportData()">å¯¼å‡ºæ‰€æœ‰æ•°æ®</button>
                <button class="btn btn-secondary" onclick="importData()">å¯¼å…¥æ•°æ®</button>
                <button class="btn btn-secondary" onclick="clearData()">æ¸…ç©ºæ•°æ®</button>
            </div>
        </div>
    </div>
    
    <input type="file" id="importFileInput" accept=".json" class="hidden" onchange="handleImportFile(event)">
    
    <script>
        // æœ¬åœ°å­˜å‚¨ç®¡ç†å™¨
        class LocalStorageManager {
            constructor() {
                this.storageKey = 'traenote_data';
                this.maxStorageSize = 50 * 1024 * 1024; // 50MB æ¨¡æ‹Ÿé™åˆ¶
            }
            
            getAllData() {
                try {
                    const data = localStorage.getItem(this.storageKey);
                    return data ? JSON.parse(data) : {
                        videos: [],
                        notebooks: [],
                        notes: [],
                        storageUsed: 0
                    };
                } catch (error) {
                    console.error('è·å–æ•°æ®å¤±è´¥:', error);
                    return { videos: [], notebooks: [], notes: [], storageUsed: 0 };
                }
            }
            
            saveData(data) {
                try {
                    localStorage.setItem(this.storageKey, JSON.stringify(data));
                    return true;
                } catch (error) {
                    console.error('ä¿å­˜æ•°æ®å¤±è´¥:', error);
                    if (error.name === 'QuotaExceededError') {
                        alert('å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œè¯·æ¸…ç†ä¸€äº›æ•°æ®åå†è¯•ã€‚');
                    }
                    return false;
                }
            }
            
            addVideo(videoData) {
                const data = this.getAllData();
                videoData.id = Date.now().toString();
                videoData.uploadTime = new Date().toISOString();
                videoData.status = 'pending';
                data.videos.push(videoData);
                data.storageUsed += this.calculateSize(videoData);
                return this.saveData(data) ? videoData : null;
            }
            
            updateVideo(id, updates) {
                const data = this.getAllData();
                const index = data.videos.findIndex(v => v.id === id);
                if (index !== -1) {
                    data.videos[index] = { ...data.videos[index], ...updates };
                    return this.saveData(data);
                }
                return false;
            }
            
            addNotebook(notebook) {
                const data = this.getAllData();
                notebook.id = Date.now().toString();
                notebook.createdAt = new Date().toISOString();
                data.notebooks.push(notebook);
                return this.saveData(data) ? notebook : null;
            }
            
            addNote(note) {
                const data = this.getAllData();
                note.id = Date.now().toString();
                note.createdAt = new Date().toISOString();
                note.updatedAt = new Date().toISOString();
                data.notes.push(note);
                return this.saveData(data) ? note : null;
            }
            
            updateNote(id, updates) {
                const data = this.getAllData();
                const index = data.notes.findIndex(n => n.id === id);
                if (index !== -1) {
                    data.notes[index] = { ...data.notes[index], ...updates, updatedAt: new Date().toISOString() };
                    return this.saveData(data);
                }
                return false;
            }
            
            calculateSize(item) {
                // æ¨¡æ‹Ÿå¤§å°è®¡ç®—
                return Math.floor(Math.random() * 1024 * 1024) + 1024 * 1024; // 1-2MB
            }
            
            getStorageUsage() {
                const data = this.getAllData();
                return {
                    used: data.storageUsed,
                    total: this.maxStorageSize,
                    percentage: (data.storageUsed / this.maxStorageSize) * 100
                };
            }
        }
        
        // å…¨å±€å˜é‡
        const storageManager = new LocalStorageManager();
        let currentVideo = null;
        
        // é¡µé¢åˆ‡æ¢
        function showPage(pageId) {
            // éšè—æ‰€æœ‰é¡µé¢
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // æ˜¾ç¤ºæŒ‡å®šé¡µé¢
            document.getElementById(pageId).classList.add('active');
            
            // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // åŠ è½½é¡µé¢æ•°æ®
            loadPageData(pageId);
        }
        
        // åŠ è½½é¡µé¢æ•°æ®
        function loadPageData(pageId) {
            switch(pageId) {
                case 'videos':
                    loadVideos();
                    break;
                case 'notebooks':
                    loadNotebooks();
                    break;
                case 'editor':
                    loadEditorData();
                    break;
                case 'storage':
                    loadStorageData();
                    break;
            }
        }
        
        // åˆå§‹åŒ–ä¸Šä¼ åŒºåŸŸ
        function initUploadArea() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type.startsWith('video/')) {
                    handleFileUpload(files[0]);
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileUpload(e.target.files[0]);
                }
            });
        }
        
        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        function handleFileUpload(file) {
            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.innerHTML = '<div class="loading">æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...</div>';
            
            // æ¨¡æ‹Ÿä¸Šä¼ è¿‡ç¨‹
            setTimeout(() => {
                const videoData = {
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    file: file
                };
                
                const notebookId = document.getElementById('uploadNotebook').value;
                const newNotebookName = document.getElementById('newNotebookName').value;
                
                if (notebookId) {
                    videoData.notebookId = notebookId;
                } else if (newNotebookName) {
                    const notebook = storageManager.addNotebook({
                        name: newNotebookName,
                        description: 'æ–°åˆ›å»ºçš„ç¬”è®°æœ¬'
                    });
                    if (notebook) {
                        videoData.notebookId = notebook.id;
                    }
                }
                
                const savedVideo = storageManager.addVideo(videoData);
                if (savedVideo) {
                    statusDiv.innerHTML = '<div class="success">æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼æ­£åœ¨å¤„ç†...</div>';
                    
                    // æ¨¡æ‹ŸAIå¤„ç†
                    setTimeout(() => {
                        storageManager.updateVideo(savedVideo.id, {
                            status: 'processing'
                        });
                        
                        setTimeout(() => {
                            storageManager.updateVideo(savedVideo.id, {
                                status: 'completed',
                                summary: 'è¿™æ˜¯AIç”Ÿæˆçš„è§†é¢‘æ‘˜è¦å†…å®¹ã€‚',
                                transcription: 'è¿™æ˜¯AIç”Ÿæˆçš„è½¬å½•æ–‡æœ¬å†…å®¹ã€‚'
                            });
                            statusDiv.innerHTML = '<div class="success">è§†é¢‘å¤„ç†å®Œæˆï¼</div>';
                        }, 3000);
                    }, 2000);
                } else {
                    statusDiv.innerHTML = '<div class="error">æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚</div>';
                }
            }, 1000);
        }
        
        // å¤„ç†è§†é¢‘URL
        function processVideoUrl() {
            const url = document.getElementById('videoUrl').value;
            if (!url) {
                alert('è¯·è¾“å…¥è§†é¢‘URL');
                return;
            }
            
            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.innerHTML = '<div class="loading">æ­£åœ¨å¤„ç†è§†é¢‘URL...</div>';
            
            setTimeout(() => {
                const videoData = {
                    name: 'ç½‘ç»œè§†é¢‘',
                    url: url,
                    type: 'video/url'
                };
                
                const notebookId = document.getElementById('uploadNotebook').value;
                const newNotebookName = document.getElementById('newNotebookName').value;
                
                if (notebookId) {
                    videoData.notebookId = notebookId;
                } else if (newNotebookName) {
                    const notebook = storageManager.addNotebook({
                        name: newNotebookName,
                        description: 'æ–°åˆ›å»ºçš„ç¬”è®°æœ¬'
                    });
                    if (notebook) {
                        videoData.notebookId = notebook.id;
                    }
                }
                
                const savedVideo = storageManager.addVideo(videoData);
                if (savedVideo) {
                    statusDiv.innerHTML = '<div class="success">è§†é¢‘URLå¤„ç†æˆåŠŸï¼</div>';
                    
                    // æ¨¡æ‹ŸAIå¤„ç†
                    setTimeout(() => {
                        storageManager.updateVideo(savedVideo.id, {
                            status: 'processing'
                        });
                        
                        setTimeout(() => {
                            storageManager.updateVideo(savedVideo.id, {
                                status: 'completed',
                                summary: 'è¿™æ˜¯AIç”Ÿæˆçš„è§†é¢‘æ‘˜è¦å†…å®¹ã€‚',
                                transcription: 'è¿™æ˜¯AIç”Ÿæˆçš„è½¬å½•æ–‡æœ¬å†…å®¹ã€‚'
                            });
                            statusDiv.innerHTML = '<div class="success">è§†é¢‘å¤„ç†å®Œæˆï¼</div>';
                        }, 3000);
                    }, 2000);
                } else {
                    statusDiv.innerHTML = '<div class="error">è§†é¢‘å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚</div>';
                }
            }, 1000);
        }
        
        // åŠ è½½è§†é¢‘åˆ—è¡¨
        function loadVideos() {
            const data = storageManager.getAllData();
            const videoList = document.getElementById('videoList');
            
            if (data.videos.length === 0) {
                videoList.innerHTML = '<p style="text-align: center; color: #666;">æš‚æ— è§†é¢‘ï¼Œè¯·å…ˆä¸Šä¼ è§†é¢‘ã€‚</p>';
                return;
            }
            
            videoList.innerHTML = data.videos.map(video => `
                <div class="video-card">
                    <h3>${video.name}</h3>
                    <div class="status ${video.status}">${getStatusText(video.status)}</div>
                    <p><strong>å¤§å°ï¼š</strong> ${formatFileSize(video.size)}</p>
                    <p><strong>ä¸Šä¼ æ—¶é—´ï¼š</strong> ${formatDate(video.uploadTime)}</p>
                    ${video.summary ? `<p><strong>æ‘˜è¦ï¼š</strong> ${video.summary}</p>` : ''}
                    <div style="margin-top: 10px;">
                        <button class="btn btn-primary" onclick="editVideo('${video.id}')">ç¼–è¾‘ç¬”è®°</button>
                        <button class="btn btn-secondary" onclick="deleteVideo('${video.id}')">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }
        
        // åŠ è½½ç¬”è®°æœ¬åˆ—è¡¨
        function loadNotebooks() {
            const data = storageManager.getAllData();
            const notebookList = document.getElementById('notebookList');
            
            if (data.notebooks.length === 0) {
                notebookList.innerHTML = '<p style="text-align: center; color: #666;">æš‚æ— ç¬”è®°æœ¬ï¼Œè¯·å…ˆåˆ›å»ºç¬”è®°æœ¬ã€‚</p>';
                return;
            }
            
            notebookList.innerHTML = data.notebooks.map(notebook => {
                const videoCount = data.videos.filter(v => v.notebookId === notebook.id).length;
                const noteCount = data.notes.filter(n => n.notebookId === notebook.id).length;
                
                return `
                    <div class="notebook-card" onclick="viewNotebook('${notebook.id}')">
                        <h3>${notebook.name}</h3>
                        <p>${notebook.description || 'æš‚æ— æè¿°'}</p>
                        <p><strong>è§†é¢‘æ•°é‡ï¼š</strong> ${videoCount}</p>
                        <p><strong>ç¬”è®°æ•°é‡ï¼š</strong> ${noteCount}</p>
                        <p><strong>åˆ›å»ºæ—¶é—´ï¼š</strong> ${formatDate(notebook.createdAt)}</p>
                        <div style="margin-top: 10px;">
                            <button class="btn btn-secondary" onclick="event.stopPropagation(); deleteNotebook('${notebook.id}')">åˆ é™¤</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // æ›´æ–°ä¸Šä¼ é¡µé¢çš„ç¬”è®°æœ¬é€‰æ‹©å™¨
            updateNotebookSelect();
        }
        
        // åŠ è½½ç¼–è¾‘å™¨æ•°æ®
        function loadEditorData() {
            const data = storageManager.getAllData();
            const videoSelect = document.getElementById('editorVideoSelect');
            
            const completedVideos = data.videos.filter(v => v.status === 'completed');
            
            if (completedVideos.length === 0) {
                videoSelect.innerHTML = '<option value="">æš‚æ— å·²å¤„ç†çš„è§†é¢‘</option>';
                return;
            }
            
            videoSelect.innerHTML = '<option value="">é€‰æ‹©è¦ç¼–è¾‘çš„è§†é¢‘</option>' + 
                completedVideos.map(video => `<option value="${video.id}">${video.name}</option>`).join('');
            
            videoSelect.addEventListener('change', (e) => {
                if (e.target.value) {
                    loadVideoForEdit(e.target.value);
                }
            });
        }
        
        // åŠ è½½å­˜å‚¨æ•°æ®
        function loadStorageData() {
            const data = storageManager.getAllData();
            const usage = storageManager.getStorageUsage();
            
            document.getElementById('totalStorage').textContent = formatFileSize(usage.used);
            document.getElementById('videoCount').textContent = data.videos.length;
            document.getElementById('noteCount').textContent = data.notes.length;
            document.getElementById('notebookCount').textContent = data.notebooks.length;
            
            const progressBar = document.getElementById('storageProgress');
            progressBar.style.width = Math.min(usage.percentage, 100) + '%';
        }
        
        // è¾…åŠ©å‡½æ•°
        function getStatusText(status) {
            const statusMap = {
                'pending': 'å¾…å¤„ç†',
                'processing': 'å¤„ç†ä¸­',
                'completed': 'å·²å®Œæˆ',
                'failed': 'å¤„ç†å¤±è´¥'
            };
            return statusMap[status] || status;
        }
        
        function formatFileSize(bytes) {
            if (!bytes) return 'æœªçŸ¥';
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'æœªçŸ¥';
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN') + ' ' + date.toLocaleTimeString('zh-CN');
        }
        
        function updateNotebookSelect() {
            const data = storageManager.getAllData();
            const select = document.getElementById('uploadNotebook');
            
            select.innerHTML = '<option value="">åˆ›å»ºæ–°ç¬”è®°æœ¬</option>' +
                data.notebooks.map(notebook => `<option value="${notebook.id}">${notebook.name}</option>`).join('');
        }
        
        // ç¼–è¾‘è§†é¢‘
        function editVideo(videoId) {
            showPage('editor');
            document.getElementById('editorVideoSelect').value = videoId;
            loadVideoForEdit(videoId);
        }
        
        // åŠ è½½è§†é¢‘è¿›è¡Œç¼–è¾‘
        function loadVideoForEdit(videoId) {
            const data = storageManager.getAllData();
            const video = data.videos.find(v => v.id === videoId);
            
            if (video) {
                currentVideo = video;
                document.getElementById('noteTitle').value = video.name + ' çš„ç¬”è®°';
                document.getElementById('aiSummary').value = video.summary || '';
                
                // æŸ¥æ‰¾ç°æœ‰ç¬”è®°
                const existingNote = data.notes.find(n => n.videoId === videoId);
                if (existingNote) {
                    document.getElementById('noteContent').value = existingNote.content || '';
                }
            }
        }
        
        // ä¿å­˜ç¬”è®°
        function saveNote() {
            if (!currentVideo) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§†é¢‘');
                return;
            }
            
            const title = document.getElementById('noteTitle').value;
            const content = document.getElementById('noteContent').value;
            const summary = document.getElementById('aiSummary').value;
            
            if (!title.trim()) {
                alert('è¯·è¾“å…¥ç¬”è®°æ ‡é¢˜');
                return;
            }
            
            const data = storageManager.getAllData();
            const existingNote = data.notes.find(n => n.videoId === currentVideo.id);
            
            let result;
            if (existingNote) {
                result = storageManager.updateNote(existingNote.id, {
                    title: title,
                    content: content,
                    summary: summary
                });
            } else {
                result = storageManager.addNote({
                    videoId: currentVideo.id,
                    notebookId: currentVideo.notebookId,
                    title: title,
                    content: content,
                    summary: summary
                });
            }
            
            const statusDiv = document.getElementById('editorStatus');
            if (result) {
                statusDiv.innerHTML = '<div class="success">ç¬”è®°ä¿å­˜æˆåŠŸï¼</div>';
                setTimeout(() => statusDiv.innerHTML = '', 3000);
            } else {
                statusDiv.innerHTML = '<div class="error">ç¬”è®°ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚</div>';
            }
        }
        
        // ç”ŸæˆAIæ‘˜è¦
        function generateAISummary() {
            if (!currentVideo) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§†é¢‘');
                return;
            }
            
            const statusDiv = document.getElementById('editorStatus');
            statusDiv.innerHTML = '<div class="loading">æ­£åœ¨ç”ŸæˆAIæ‘˜è¦...</div>';
            
            setTimeout(() => {
                const summary = 'è¿™æ˜¯AIé‡æ–°ç”Ÿæˆçš„æ‘˜è¦å†…å®¹ï¼ŒåŸºäºè§†é¢‘å†…å®¹åˆ†æå¾—å‡ºã€‚';
                document.getElementById('aiSummary').value = summary;
                statusDiv.innerHTML = '<div class="success">AIæ‘˜è¦ç”Ÿæˆå®Œæˆï¼</div>';
                setTimeout(() => statusDiv.innerHTML = '', 3000);
            }, 2000);
        }
        
        // å¯¼å‡ºç¬”è®°
        function exportNote() {
            if (!currentVideo) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§†é¢‘');
                return;
            }
            
            const title = document.getElementById('noteTitle').value;
            const content = document.getElementById('noteContent').value;
            const summary = document.getElementById('aiSummary').value;
            
            const noteContent = `# ${title}

## è§†é¢‘ä¿¡æ¯
- è§†é¢‘åç§°: ${currentVideo.name}
- å¤„ç†æ—¶é—´: ${formatDate(currentVideo.uploadTime)}

## AIæ‘˜è¦
${summary}

## ç¬”è®°å†…å®¹
${content}

---
*ç”±æ™ºè®°ç¬”è®°APPç”Ÿæˆ* - ${new Date().toLocaleString('zh-CN')}
`;
            
            const blob = new Blob([noteContent], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${title}.md`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // åˆ›å»ºç¬”è®°æœ¬
        function createNotebook() {
            const name = prompt('è¯·è¾“å…¥ç¬”è®°æœ¬åç§°ï¼š');
            if (!name || !name.trim()) return;
            
            const description = prompt('è¯·è¾“å…¥ç¬”è®°æœ¬æè¿°ï¼ˆå¯é€‰ï¼‰ï¼š');
            
            const notebook = storageManager.addNotebook({
                name: name.trim(),
                description: description ? description.trim() : ''
            });
            
            if (notebook) {
                alert('ç¬”è®°æœ¬åˆ›å»ºæˆåŠŸï¼');
                loadNotebooks();
            } else {
                alert('ç¬”è®°æœ¬åˆ›å»ºå¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');
            }
        }
        
        // æŸ¥çœ‹ç¬”è®°æœ¬
        function viewNotebook(notebookId) {
            const data = storageManager.getAllData();
            const notebook = data.notebooks.find(n => n.id === notebookId);
            const videos = data.videos.filter(v => v.notebookId === notebookId);
            
            if (notebook) {
                alert(`ç¬”è®°æœ¬ï¼š${notebook.name}\nåŒ…å« ${videos.length} ä¸ªè§†é¢‘\næè¿°ï¼š${notebook.description || 'æš‚æ— æè¿°'}`);
            }
        }
        
        // åˆ é™¤è§†é¢‘
        function deleteVideo(videoId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè§†é¢‘å—ï¼Ÿ')) return;
            
            const data = storageManager.getAllData();
            const videoIndex = data.videos.findIndex(v => v.id === videoId);
            
            if (videoIndex !== -1) {
                data.videos.splice(videoIndex, 1);
                // åˆ é™¤ç›¸å…³ç¬”è®°
                data.notes = data.notes.filter(n => n.videoId !== videoId);
                
                if (storageManager.saveData(data)) {
                    alert('è§†é¢‘åˆ é™¤æˆåŠŸï¼');
                    loadVideos();
                } else {
                    alert('è§†é¢‘åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');
                }
            }
        }
        
        // åˆ é™¤ç¬”è®°æœ¬
        function deleteNotebook(notebookId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç¬”è®°æœ¬å—ï¼Ÿç¬”è®°æœ¬ä¸­çš„è§†é¢‘ä¸ä¼šè¢«åˆ é™¤ã€‚')) return;
            
            const data = storageManager.getAllData();
            const notebookIndex = data.notebooks.findIndex(n => n.id === notebookId);
            
            if (notebookIndex !== -1) {
                data.notebooks.splice(notebookIndex, 1);
                
                if (storageManager.saveData(data)) {
                    alert('ç¬”è®°æœ¬åˆ é™¤æˆåŠŸï¼');
                    loadNotebooks();
                } else {
                    alert('ç¬”è®°æœ¬åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');
                }
            }
        }
        
        // å¯¼å‡ºæ•°æ®
        function exportData() {
            const data = storageManager.getAllData();
            const jsonData = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `traenote_backup_${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // å¯¼å…¥æ•°æ®
        function importData() {
            document.getElementById('importFileInput').click();
        }
        
        // å¤„ç†å¯¼å…¥æ–‡ä»¶
        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (confirm('å¯¼å…¥æ•°æ®å°†è¦†ç›–ç°æœ‰æ•°æ®ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                        if (storageManager.saveData(importedData)) {
                            alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼');
                            location.reload();
                        } else {
                            alert('æ•°æ®å¯¼å…¥å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');
                        }
                    }
                } catch (error) {
                    alert('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œè¯·é€‰æ‹©æœ‰æ•ˆçš„å¤‡ä»½æ–‡ä»¶ã€‚');
                }
            };
            reader.readAsText(file);
        }
        
        // æ¸…ç©ºæ•°æ®
        function clearData() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                localStorage.removeItem('traenote_data');
                alert('æ•°æ®å·²æ¸…ç©ºï¼');
                location.reload();
            }
        }
        
        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            try {
                // æµ‹è¯•æœ¬åœ°å­˜å‚¨
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                
                // åˆå§‹åŒ–ä¸Šä¼ åŒºåŸŸ
                initUploadArea();
                
                // æ·»åŠ ä¸€äº›æ¼”ç¤ºæ•°æ®
                addDemoData();
                
                console.log('æ™ºè®°ç¬”è®°APPåˆå§‹åŒ–å®Œæˆï¼');
            } catch (error) {
                console.error('åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', error);
                document.body.innerHTML = '<div style="padding: 20px; text-align: center; color: red;"><h2>åº”ç”¨åˆå§‹åŒ–å¤±è´¥</h2><p>è¯·ç¡®ä¿æµè§ˆå™¨æ”¯æŒæœ¬åœ°å­˜å‚¨åŠŸèƒ½ã€‚</p></div>';
            }
        }
        
        // æ·»åŠ æ¼”ç¤ºæ•°æ®
        function addDemoData() {
            const data = storageManager.getAllData();
            
            // å¦‚æœå·²ç»æœ‰æ•°æ®ï¼Œä¸æ·»åŠ æ¼”ç¤ºæ•°æ®
            if (data.videos.length > 0 || data.notebooks.length > 0) {
                return;
            }
            
            // åˆ›å»ºæ¼”ç¤ºç¬”è®°æœ¬
            const demoNotebook = storageManager.addNotebook({
                name: 'æ¼”ç¤ºç¬”è®°æœ¬',
                description: 'è¿™æ˜¯ä¸€ä¸ªæ¼”ç¤ºç¬”è®°æœ¬ï¼ŒåŒ…å«ç¤ºä¾‹è§†é¢‘å’Œç¬”è®°ã€‚'
            });
            
            if (demoNotebook) {
                // åˆ›å»ºæ¼”ç¤ºè§†é¢‘
                const demoVideo = storageManager.addVideo({
                    name: 'æ¼”ç¤ºè§†é¢‘.mp4',
                    size: 1024 * 1024 * 15, // 15MB
                    type: 'video/mp4',
                    notebookId: demoNotebook.id
                });
                
                if (demoVideo) {
                    // æ¨¡æ‹Ÿè§†é¢‘å¤„ç†å®Œæˆ
                    setTimeout(() => {
                        storageManager.updateVideo(demoVideo.id, {
                            status: 'completed',
                            summary: 'è¿™æ˜¯ä¸€ä¸ªæ¼”ç¤ºè§†é¢‘çš„AIç”Ÿæˆæ‘˜è¦ã€‚è§†é¢‘å†…å®¹åŒ…å«äº†é‡è¦çš„çŸ¥è¯†ç‚¹å’Œå­¦ä¹ è¦ç‚¹ã€‚',
                            transcription: 'è¿™æ˜¯AIç”Ÿæˆçš„è½¬å½•æ–‡æœ¬å†…å®¹ï¼ŒåŒ…å«äº†è§†é¢‘ä¸­çš„ä¸»è¦å¯¹è¯å’Œä¿¡æ¯ã€‚'
                        });
                        
                        // åˆ›å»ºæ¼”ç¤ºç¬”è®°
                        storageManager.addNote({
                            videoId: demoVideo.id,
                            notebookId: demoNotebook.id,
                            title: 'æ¼”ç¤ºè§†é¢‘å­¦ä¹ ç¬”è®°',
                            content: 'è¿™æ˜¯æˆ‘çš„å­¦ä¹ ç¬”è®°ï¼š\n\n1. é‡è¦çŸ¥è¯†ç‚¹ä¸€\n2. é‡è¦çŸ¥è¯†ç‚¹äºŒ\n3. éœ€è¦å¤ä¹ çš„å†…å®¹\n\n## æ€»ç»“\nè¿™ä¸ªè§†é¢‘è®©æˆ‘å­¦åˆ°äº†å¾ˆå¤šæœ‰ç”¨çš„çŸ¥è¯†ã€‚',
                            summary: 'è¿™æ˜¯ä¸€ä¸ªæ¼”ç¤ºè§†é¢‘çš„AIç”Ÿæˆæ‘˜è¦ã€‚è§†é¢‘å†…å®¹åŒ…å«äº†é‡è¦çš„çŸ¥è¯†ç‚¹å’Œå­¦ä¹ è¦ç‚¹ã€‚'
                        });
                    }, 1000);
                }
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>